#!/usr/bin/env node

const { execSync, spawnSync } = require("child_process");
const { existsSync } = require("fs");
const { join } = require("path");

const PLATFORMS = {
  win32: {
    x64: "jj-ryu-win32-x64/ryu.exe",
    arm64: "jj-ryu-win32-arm64/ryu.exe",
  },
  darwin: {
    x64: "jj-ryu-darwin-x64/ryu",
    arm64: "jj-ryu-darwin-arm64/ryu",
  },
  linux: {
    x64: "jj-ryu-linux-x64/ryu",
    arm64: "jj-ryu-linux-arm64/ryu",
  },
  "linux-musl": {
    x64: "jj-ryu-linux-x64-musl/ryu",
    arm64: "jj-ryu-linux-arm64-musl/ryu",
  },
};

function isMusl() {
  if (process.platform !== "linux") return false;

  // Check for Alpine
  if (existsSync("/etc/alpine-release")) return true;

  // Check ldd output
  try {
    const output = execSync("ldd --version 2>&1", { encoding: "utf8" });
    return output.toLowerCase().includes("musl");
  } catch (err) {
    // ldd failed - check if error message mentions musl
    const stderr = err.stderr?.toString() || err.message || "";
    return stderr.toLowerCase().includes("musl");
  }
}

function getBinaryPath() {
  // Allow override via environment variable
  if (process.env.RYU_BINARY_PATH) {
    return process.env.RYU_BINARY_PATH;
  }

  const { platform, arch } = process;
  const platformKey = platform === "linux" && isMusl() ? "linux-musl" : platform;
  const packagePath = PLATFORMS[platformKey]?.[arch];

  if (!packagePath) {
    return null;
  }

  try {
    return require.resolve(packagePath);
  } catch {
    return null;
  }
}

function main() {
  const binPath = getBinaryPath();

  if (!binPath) {
    console.error(`Error: No prebuilt ryu binary for ${process.platform}-${process.arch}`);
    console.error();
    console.error("You can:");
    console.error("  1. Build from source: cargo install jj-ryu");
    console.error("  2. Set RYU_BINARY_PATH to a custom binary location");
    console.error();
    console.error("Supported platforms:");
    console.error("  - darwin-arm64 (macOS Apple Silicon)");
    console.error("  - darwin-x64 (macOS Intel)");
    console.error("  - linux-arm64 (Linux ARM64 glibc)");
    console.error("  - linux-x64 (Linux x64 glibc)");
    console.error("  - linux-arm64-musl (Linux ARM64 musl/Alpine)");
    console.error("  - linux-x64-musl (Linux x64 musl/Alpine)");
    console.error("  - win32-arm64 (Windows ARM64)");
    console.error("  - win32-x64 (Windows x64)");
    process.exit(1);
  }

  const result = spawnSync(binPath, process.argv.slice(2), {
    stdio: "inherit",
    shell: false,
  });

  if (result.error) {
    if (result.error.code === "ENOENT") {
      console.error(`Error: Binary not found at ${binPath}`);
      console.error("Try reinstalling: npm install jj-ryu");
    } else {
      console.error(`Error executing ryu: ${result.error.message}`);
    }
    process.exit(1);
  }

  process.exit(result.status ?? 1);
}

main();
